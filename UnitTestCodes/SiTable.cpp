#include "Include/Foundation/SystemInclude.h"
#include <cppunit/extensions/HelperMacros.h>

/* Foundation */
#include "Include/Foundation/Type.h"
#include "Include/Foundation/Debug.h"

/* TsPacketSiTable */
#include "Include/TsPacketSiTable/SiTableInterface.h"

#include "DescriptorHelper.h"
#include "SiTable.h"
using namespace std;

CxxBeginNameSpace(UnitTest)
    
/**********************class SiTable**********************/
CPPUNIT_TEST_SUITE_REGISTRATION(SiTable);

void SiTable::TestBatConstruct()
{    
    BouquetId bouquetId = 1;
    Version   version = 1;

    BatTableInterface *bat;
    bat = BatTableInterface::CreateInstance(InvalidSiTableTableId, bouquetId, version);
	CPPUNIT_ASSERT(bat == nullptr);

    bat = BatTableInterface::CreateInstance(BatTableId, bouquetId, version);
    CPPUNIT_ASSERT(bat != nullptr);
    delete bat;
}

void SiTable::TestBatGetCodesSize()
{
    BouquetId bouquetId = 1;
    Version   version = 1;
    TsId      tsId = 1;
    OnId      onId = 0;

    std::list<TsId> tsIds;
    tsIds.push_back(tsId);

    auto_ptr<BatTableInterface> bat(BatTableInterface::CreateInstance(BatTableId, bouquetId, version));
    CPPUNIT_ASSERT(bat->GetCodesSize(BatTableId, tsIds, 0) == sizeof(bouquet_association_section));

    uint_t desSize = 100;
    uint_t desNumber = (MaxBatDesAndTsContentSize - 2) / desSize;
    for (uint_t i = 0; i < desNumber; ++i)
    {
        bat->AddDescriptor(GetDescriptorString(desSize));
    }
    bat->AddDescriptor(GetDescriptorString(MaxBatDesAndTsContentSize - desSize * desNumber));
    CPPUNIT_ASSERT(bat->GetCodesSize(BatTableId, tsIds, 0) == MaxBatSectionLength);

    bat->AddTs(tsId, onId);
    size_t size = sizeof(bouquet_association_section) + sizeof(transport_stream);
    CPPUNIT_ASSERT(bat->GetCodesSize(BatTableId, tsIds, 0) == MaxBatSectionLength);
    CPPUNIT_ASSERT(bat->GetCodesSize(BatTableId, tsIds, 1) == size);
}

void SiTable::TestBatGetKey()
{
    BouquetId bouquetId = 1;
    Version   version = 1;

    auto_ptr<BatTableInterface> bat(BatTableInterface::CreateInstance(BatTableId, bouquetId, version));
    CPPUNIT_ASSERT(bat->GetKey() == bouquetId);
}

void SiTable::TestBatGetSecNumber()
{
    BouquetId bouquetId = 1;
    Version   version = 1;
    TsId      tsId = 1;
    OnId      onId = 0;

    std::list<TsId> tsIds;
    tsIds.push_back(tsId);

    auto_ptr<BatTableInterface> bat(BatTableInterface::CreateInstance(BatTableId, bouquetId, version));
    CPPUNIT_ASSERT(bat->GetSecNumber(InvalidSiTableTableId, tsIds) == 0);
    CPPUNIT_ASSERT(bat->GetSecNumber(BatTableId, tsIds) == 1);

    uint_t desSize = 100;
    uint_t desNumber = (MaxBatDesAndTsContentSize - 2) / desSize;
    for (uint_t i = 0; i < desNumber; ++i)
    {
        bat->AddDescriptor(GetDescriptorString(desSize));
    }
    bat->AddDescriptor(GetDescriptorString(MaxBatDesAndTsContentSize - desSize * desNumber));
    CPPUNIT_ASSERT(bat->GetSecNumber(BatTableId, tsIds) == 1);

    bat->AddTs(tsId, onId);
    CPPUNIT_ASSERT(bat->GetSecNumber(BatTableId, tsIds) == 2);
}

void SiTable::TestBatGetTableId()
{
    BouquetId bouquetId = 1;
    Version   version = 1;
    TsId      tsId = 1;
    OnId      onId = 0;

    std::list<TsId> tsIds;
    tsIds.push_back(tsId);

    auto_ptr<BatTableInterface> bat(BatTableInterface::CreateInstance(BatTableId, bouquetId, version));
    CPPUNIT_ASSERT(bat->GetTableId() == BatTableId);
}

void SiTable::TestBatMakeCodes()
{
    BouquetId bouquetId = 1;
    Version   version = 1;
    TsId      tsId = 1;
    OnId      onId = 0;

    std::list<TsId> tsIds;
    tsIds.push_back(tsId);

    static uchar_t buffer[1024];
    auto_ptr<BatTableInterface> bat1(BatTableInterface::CreateInstance(BatTableId, bouquetId, version));
    uchar_t code1[] = 
    { 
        0x4a, 0xf0, 0x1e, 0x00, 0x01, 0xc3, 0x00, 0x00, 0xf0, 0x00, 0xf0, 0x11, 0x00, 0x01, 0x00, 0x00, 
        0xf0, 0x0b, 0x41, 0x09, 0x00, 0x03, 0x01, 0x00, 0x02, 0x01, 0x00, 0x01, 0x01, 0xef, 0xec, 0x08, 
        0x9c
    };
    bat1->AddTs(tsId, onId);
    bat1->AddTsDescriptor(tsId, string("4109000301000201000101"));
    bat1->MakeCodes(BatTableId, tsIds, buffer, 1024, 0);
    CPPUNIT_ASSERT(memcmp(buffer, code1, bat1->GetCodesSize(BatTableId, tsIds, 0)) == 0);

    auto_ptr<BatTableInterface> bat2(BatTableInterface::CreateInstance(BatTableId, bouquetId, version));
    uchar_t code2[] = 
    { 
        0x4a, 0xf3, 0xfd, 0x00, 0x01, 0xc3, 0x00, 0x00, 0xf3, 0xf0, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03,
        0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19,
        0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35,
        0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01,
        0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
        0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33,
        0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15,
        0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31,
        0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47,
        0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13,
        0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29,
        0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45,
        0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11,
        0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27,
        0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43,
        0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
        0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25,
        0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41,
        0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23,
        0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39,
        0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05,
        0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21,
        0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
        0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03,
        0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19,
        0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35,
        0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01,
        0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
        0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33,
        0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15,
        0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31,
        0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47,
        0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13,
        0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29,
        0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45,
        0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11,
        0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27,
        0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43,
        0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09,
        0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25,
        0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41,
        0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07,
        0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23,
        0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39,
        0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05,
        0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21,
        0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37,
        0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01, 0x02, 0x03,
        0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17, 0x18, 0x19,
        0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33, 0x34, 0x35,
        0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30, 0x00, 0x01,
        0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15, 0x16, 0x17,
        0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31, 0x32, 0x33,
        0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47, 0xfe, 0x30,
        0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13, 0x14, 0x15,
        0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29, 0x30, 0x31,
        0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45, 0x46, 0x47,
        0xfe, 0x30, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x10, 0x11, 0x12, 0x13,
        0x14, 0x15, 0x16, 0x17, 0x18, 0x19, 0x20, 0x21, 0x22, 0x23, 0x24, 0x25, 0x26, 0x27, 0x28, 0x29,
        0x30, 0x31, 0x32, 0x33, 0x34, 0x35, 0x36, 0x37, 0x38, 0x39, 0x40, 0x41, 0x42, 0x43, 0x44, 0x45,
        0x46, 0x47, 0xfe, 0x06, 0x00, 0x01, 0x02, 0x03, 0x04, 0x05, 0xf0, 0x00, 0xa1, 0x6e, 0xe0, 0xbb
    };

    uint_t desSize = 50;
    uint_t desNumber = (MaxBatDesAndTsContentSize - 2) / desSize;
    // "FE30000102030405060708091011121314151617181920212223242526272829303132333435363738394041424344454647"
    string descriptor50 = GetDescriptorString(desSize);
    for (uint_t i = 0; i < desNumber; ++i)
    {
        bat2->AddDescriptor(descriptor50);
    }
    // "FE06000102030405"
    string descriptor8 = GetDescriptorString(MaxBatDesAndTsContentSize - desSize * desNumber);
    bat2->AddDescriptor(descriptor8);
    bat2->MakeCodes(BatTableId, tsIds, buffer, 1024, 0);
    CPPUNIT_ASSERT(memcmp(buffer, code2, bat2->GetCodesSize(BatTableId, tsIds, 0)) == 0);

    uchar_t code3[] = 
    { 
        0x4a, 0xf0, 0x13, 0x00, 0x01, 0xc3, 0x01, 0x01, 0xf0, 0x00, 0xf0, 0x06, 0x00, 0x01, 0x00, 0x00,
        0xf0, 0x00, 0xd5, 0x20, 0xe9, 0xf6
    };
    bat2->AddTs(tsId, onId);
    bat2->MakeCodes(BatTableId, tsIds, buffer, 1024, 1);
    CPPUNIT_ASSERT(memcmp(buffer, code3, bat2->GetCodesSize(BatTableId, tsIds, 1)) == 0);
}

CxxEndNameSpace
